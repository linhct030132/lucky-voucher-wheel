# Lucky Draw Voucher Website — Requirements

## 0) Overview & Goals

Build a web application that lets end‑users spin for discount vouchers while staff can configure vouchers and probabilities. The draw must be **fair, auditable, and stock‑aware**, and each user/device can spin **once only**.

---

## 1) Roles & Access

- **Staff (Admin Operator)**
  - Authenticated access only (email/password + MFA optional; JWT sessions).
  - Can create/read/update/delete (CRUD) vouchers, adjust remaining quantities (stock), and set win probabilities.
  - Can view audit logs and export reports.
  - Manage the Lucky Voucher of each user
- **End‑User**
  - Public access to the spin page.
  - Must provide minimal profile info before a spin (see §3.2).

---

## 2) Non‑Functional Requirements

- **Security**: HTTPS, secure cookies, CSRF protection on admin, input validation, role‑based access control (RBAC: STAFF only).
- **Reliability**: Atomic spin operation (transactional), idempotent APIs, concurrency‑safe stock decrement.
- **Performance**: P95 spin response < 500 ms under 100 RPS; admin list page P95 < 800 ms.
- **Auditability**: Immutable logs for voucher CRUD and spin outcomes.
- **Privacy**: Collect only necessary user data; provide data retention settings.
- **Observability**: Structured logs, metrics (spins, wins by voucher, conversion), alerts on anomalies.

---

## 3) User Experience Requirements

### 3.1 End‑User Spin Page

- Shows campaign title, rules, available prize categories (without exposing exact probabilities), and CTA "Spin Now".
- Before spinning, show a simple form to collect:
  - **Required:** full name, phone/email (at least one verified field), consent checkbox.
  - **Implicit:** device fingerprint id (cookie/localStorage) and IP (server‑captured).
- After spin:
  - **Win**: display voucher name, code (or claim link), expiry, conditions, and a copy button. Email/SMS the code.
  - **No Win**: display friendly message and sharing CTA.
  - Disable any further spins for the same user/device (see §5).

### 3.2 Admin Console

- **Voucher List**: name, type/value, remaining stock, base probability (%), status (active/inactive), last modified, actions.
- **Voucher Editor**: fields (see §4.1), preview of effective odds, validation errors.
- **Logs/Reports**: filter by date, voucher, outcome, export CSV.
- **Access Control**: only STAFF role can access admin routes and APIs.

---

## 4) Functional Requirements

### 4.1 Voucher Management (Staff‑only)

- Create voucher with:
  - `name` (string)
  - `description` (string, optional, can include T&Cs)
  - `face_value` (e.g., 10% off / $5 off / free shipping)
  - `base_probability` (0.0–1.0), interpreted as weight (see §4.3)
  - `initial_stock` and **editable** `remaining_stock`
  - `max_per_user` (default 1)
  - `valid_from`, `valid_to`, `status` (draft/active/inactive)
  - `code_generation` (pre‑seeded codes list or autogenerated format)
- Update: change any mutable fields; changes are versioned and audited.
- Delete: soft‑delete only if no active stock or after campaign end; otherwise set `status=inactive`.
- Stock adjustments: manual increment/decrement with reason; all adjustments audited.

### 4.2 Spin Engine (End‑User)

- Accepts a single spin request after user submits profile + consent.
- Determines outcome based on **weighted random selection** across only vouchers that are:
  - `status=active`
  - `valid_now` (within validity window)
  - `remaining_stock > 0`
- If no eligible vouchers, return **graceful no‑win** result.
- On win: atomically reserve/decrement stock, assign a unique code, and persist the win.
- On lose: persist attempt with `outcome=lose`.

### 4.3 Probability Model (Stock‑Aware Weighted Draw)

- Each eligible voucher `i` has a configured `base_probability_i` acting as a **weight** `w_i`.
- Let the eligible set be `E` (all vouchers with stock > 0 and active). Add an optional **No‑Win** weight `w_0` to shape overall win rate.
- Effective probability of voucher `i` on a given spin:
  - `P(i) = w_i / (w_0 + Σ w_j for j∈E)`.
- When a voucher’s `remaining_stock` hits 0, remove it from `E` for subsequent spins.
- **Validation**: Admin UI must show implied win rate and warn if all weights are 0.

### 4.4 One‑Time Spin Enforcement (Per User & Device)

- A spin is allowed **once** given the tuple: `(user_identity, device_fingerprint)`.
- Enforce at API with a unique constraint on `(user_hash, device_id)` in `SpinAttempt` where `status in ('pending','completed')`.
- Also enforce by setting a durable cookie/localStorage token and capturing an HMAC’d device fingerprint.
- Attempts to bypass (clear cookies, incognito) are mitigated by additional heuristics: same phone/email/IP ASN within window → block.

### 4.5 Data Persistence & Auditing

- Persist **all** user info supplied, device metadata, outcome, voucher reference, and timestamps.
- On win, decrement stock atomically and record a `VoucherRedemption` (issued but not yet redeemed) with status `issued`.
- Maintain an immutable **AuditLog** for voucher CRUD, stock edits, and spin outcomes.

### 4.6 Notifications

- Email/SMS (configurable) on win with voucher code and T&Cs.
- Optional: send confirmation/receipt of participation.

### 4.7 Reporting & Exports

- Metrics: total spins, unique users/devices, win rate, wins by voucher, stock burn‑down, top geos, anomalies.
- CSV export of spins and issued voucher codes (with PII minimization if toggled).

---

## 5) API Specifications (Draft)

> All endpoints are JSON over HTTPS; authenticated admin routes require Bearer JWT with `role=STAFF`.

### 5.1 Admin APIs

- `POST /api/admin/vouchers` — create voucher
- `GET /api/admin/vouchers` — list vouchers (filters: status, date)
- `GET /api/admin/vouchers/:id` — get voucher
- `PUT /api/admin/vouchers/:id` — update voucher
- `DELETE /api/admin/vouchers/:id` — soft‑delete voucher
- `POST /api/admin/vouchers/:id/stock_adjustments` — adjust remaining stock `{delta, reason}`
- `GET /api/admin/logs` — audit log list
- `GET /api/admin/reports/spins` — aggregated metrics

### 5.2 Public APIs

- `POST /api/spins` — create a spin attempt
  - Request body:
    ```json
    {
      "fullName": "string",
      "email": "string|null",
      "phone": "string|null",
      "consent": true,
      "deviceId": "hashed-fp",
      "campaignId": "uuid"
    }
    ```
  - Response (win):
    ```json
    {
      "outcome": "win",
      "voucher": {
        "id": "uuid",
        "name": "10% Off",
        "code": "ABC123",
        "validTo": "2025-12-31"
      }
    }
    ```
  - Response (lose): `{ "outcome": "lose" }`
  - Errors:
    - `409 CONFLICT` already spun (per §4.4)
    - `410 GONE` campaign finished / no stock

---

## 6) Data Model (Relational‑style)

- **UserProfile**(id, full_name, email, phone, created_at, consent_at)
- **Device**(id, device_fp_hash, first_seen_at, last_seen_at)
- **Voucher**(id, name, description, face_value, base_probability, remaining_stock, max_per_user, valid_from, valid_to, status, code_generation, created_at, updated_at)
- **VoucherCode**(id, voucher_id, code, status[available|issued|redeemed|expired], issued_to_user_id, issued_at, redeemed_at)
- **SpinAttempt**(id, user_id, device_id, campaign_id, outcome[win|lose], voucher_id?, voucher_code_id?, created_at)
  - **Unique index** on `(user_id, device_id, campaign_id)`
- **Campaign**(id, name, status, start_at, end_at, no_win_weight, created_at)
- **AuditLog**(id, actor_id, actor_role, action, entity_type, entity_id, before, after, created_at, ip)

---

## 7) Transaction & Concurrency Semantics

- Spin flow must be **transactional**:
  1. Validate one‑time eligibility.
  2. Build eligible set `E` (active, in‑window, stock>0).
  3. Randomly select outcome using weights.
  4. If win: `SELECT ... FOR UPDATE` the chosen voucher row; verify `remaining_stock>0`; decrement; assign next available code; persist `SpinAttempt` + `VoucherCode(issued)`.
  5. Commit; return result.
- If contention empties stock between selection and decrement, retry selection **once**; if no eligible remains, return `lose` or `410` depending on policy.

---

## 8) Admin UI Validation Rules

- `base_probability` ∈ [0,1]; sum of weights + `no_win_weight` > 0.
- `remaining_stock` ≥ 0; cannot activate a voucher with 0 stock (warn).
- `valid_to` ≥ `valid_from`.
- Prevent deletion of a voucher that has issued codes; require inactivation.

---

## 9) Anti‑Fraud & Abuse Controls

- Device fingerprint (client‑side + server HMAC) + durable cookie.
- Block multiple spins by: phone/email duplicates, IP+UA heuristics, rate limiting (e.g., 5 POST /api/spins per IP/min).
- Optional OTP verification (email/SMS) before spin.
- ReCAPTCHA/Turnstile on form submission.

---

## 10) Operational Concerns

- **Secrets** via environment variables.
- **Feature flags** for campaign toggles.
- **Backups** for database; daily retention 30 days.
- **Data retention**: spins and PII retained N days (configurable); anonymize on expiry.

---

## 11) Acceptance Criteria (Summarized)

1. **Admin Voucher Config Page**

   - Only STAFF can access; unauthenticated users get 401/403.
   - Staff can add/edit/delete vouchers, adjust stock, set probabilities.
   - Changes are visible immediately and logged in AuditLog.

2. **User Spin Page**

   - User can submit profile and perform exactly one spin per user+device.
   - Outcome respects weights and stock; out‑of‑stock vouchers are never awarded.
   - Win shows code and triggers notification; lose shows friendly message.

3. **One‑Time Spin Enforcement**

   - Subsequent attempts with same user or device within campaign return 409.

4. **Persistence & Stock Update**
   - All attempts saved; on win, remaining stock decrements by 1 atomically.
   - Reports show totals, wins by voucher, and stock levels.

---

## 12) Pseudocode: Weighted Draw with Stock

```pseudo
function spin(user, device, campaignId):
  assert not hasSpun(user, device, campaignId)  // unique check
  E = getEligibleVouchers(campaignId)           // active, in window, stock>0
  if E is empty and no_win_weight == 0:
    return Lose
  choice = weightedRandom(E, no_win_weight)
  if choice == NO_WIN:
    recordAttempt(user, device, campaignId, outcome=lose)
    return Lose
  begin transaction
    v = select Voucher where id = choice.id for update
    if v.remaining_stock <= 0:
      rollback and return spin(user, device, campaignId) once
    v.remaining_stock -= 1
    code = claimAvailableCode(v.id)
    save SpinAttempt(outcome=win, voucher=v, code=code)
  commit
  return Win(v, code)
```

---

## 13) Open Questions (for Product/Legal)

- Do we require OTP verification before spinning?
- Do we allow a **No‑Win** outcome (recommended) to cap overall win rate?
- Exact PII fields, consent text, and retention period.
- Are voucher codes single‑use and transferable?
- Localization and accessibility requirements.

# Production

- Technical require: ReactJS, NodeJS (express refer), Mysql
- Using docker to start both of FE and BE
- Need to deploy to real life
